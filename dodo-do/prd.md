

## macOS 菜单栏应用 PRD - Todo & Countdown

### 1\. 产品概述

本产品是一个 macOS 菜单栏应用程序，旨在提供一个轻量级、便捷的个人任务管理和倒计时工具。用户可以通过菜单栏快速访问 Todo 列表，进行任务的增删改查，并查看和管理简洁的倒计时。

### 2\. 目标用户

  * 需要一个快速、不打扰的任务管理工具的 macOS 用户。
  * 希望在工作或学习中保持专注，并能随时查看重要任务和倒计时的人群。

### 3\. 核心功能模块

  * **Todo List (待办事项列表)**：核心任务管理功能。
  * **Countdown (倒计时)**：简洁的倒计时功能。

-----

### 4\. 界面布局：Tab 切换

为了区分 Todo List 和 Countdown 功能，`NSPopover` 的主界面将采用 **Tab 视图** (`TabView`) 或 **Segmented Control** 进行切换。

  * **默认显示**: 菜单栏图标点击后，默认显示 **Todo List** 界面。
  * **切换**: 用户可以点击 Tab 栏（例如，顶部）的“待办事项”和“倒计时”按钮进行切换。

-----

### 5\. Todo List 功能细化 (复习与确认)

#### 5.1 功能描述

Todo List 模块提供用户创建、查看、编辑、删除待办事项的能力，并能区分已完成和未完成的任务。

#### 5.2 功能点与交互设计

##### 5.2.1 任务列表展示

  * **排序**: 任务按照**创建时间倒序排列**（最新创建的在最上面）。
  * **状态筛选**: 界面内部提供“未完成”和“已完成”两个 **Tab 或 Segmented Control** (位于 Todo 模块内部) 进行切换。
  * **任务项显示**: 每个任务项至少显示：**标题 (Title)** 和 **完成状态 (Completion Status)** (复选框)。

##### 5.2.2 任务增删改查 (CRUD)

  * **添加任务**: 提供输入框和“添加”按钮 (或 `Enter` 键)，新任务以“未完成”状态添加。
  * **查看任务详情**: 点击任务项，弹出详情视图，显示**标题**和**内容**。
  * **编辑任务**: 在详情视图中可编辑**标题**和**内容**，并保存。
  * **删除任务**: 在详情视图提供“删除”按钮并确认；列表视图可通过右键或滑动操作删除。
  * **标记完成/未完成**: 点击复选框切换状态，任务自动移动到相应列表。

#### 5.3 数据模型 (Data Model)

```swift
struct TodoItem: Identifiable, Codable, Equatable {
    let id: UUID
    var title: String
    var content: String // 可为空
    var isCompleted: Bool
    let createdAt: Date
}
```

#### 5.4 数据持久化

  * **方案**: 推荐使用 `FileManager` 将 `[TodoItem]` 数组编码为 JSON 字符串保存到应用程序沙盒目录下的文件中。
  * **保存/加载时机**: 每次数据变更时保存；应用启动时加载。

-----

### 6\. Countdown 功能细化

#### 6.1 功能描述

Countdown 模块提供用户创建、显示、暂停、重置和删除倒计时。倒计时结束后会进行提醒。

#### 6.2 功能点与交互设计

##### 6.2.1 倒计时列表展示

  * **排序**: 倒计时按照**创建时间倒序排列**（最新创建的在最上面）。
  * **倒计时项显示**: 每个倒计时项至少显示：
      * **标题 (Title)**：必填，标识倒计时用途（例如：“番茄工作法”、“午休结束”）。
      * **剩余时间**: 实时更新的剩余时间（例如：`00:25:30`）。
      * **状态指示**: 播放/暂停图标，或文本指示（“正在运行”、“已暂停”、“已完成”）。

##### 6.2.2 倒计时管理 (CUD - 创建、删除)

  * **创建倒计时 (Create)**:
      * 界面顶部或底部提供一个“新建倒计时”按钮或区域。
      * 点击后，弹出一个创建视图（可在当前 `NSPopover` 内切换视图或作为新的 `Sheet`）。
      * 创建视图包含：
          * **标题输入框**: 用于设置倒计时的名称。
          * **时长选择器**: 允许用户设置倒计时总时长（例如，小时、分钟、秒的滚轮选择器或直接输入）。
          * “创建”和“取消”按钮。
      * **交互**: 创建成功后，新的倒计时以“暂停”状态添加到列表中。
  * **删除倒计时 (Delete)**:
      * 在倒计时列表项上，提供删除选项（例如，右键菜单、滑动操作或点击进入详情视图后的删除按钮）。
      * 点击删除后，弹出确认对话框。
      * 确认后，倒计时从列表中移除。

##### 6.2.3 倒计时操作 (暂停/重置)

  * **播放/暂停**:
      * 每个倒计时项旁边提供一个**播放/暂停按钮**。
      * 点击暂停中的倒计时，开始计时。
      * 点击运行中的倒计时，暂停计时。
  * **重置**:
      * 每个倒计时项旁边提供一个**重置按钮**（或长按播放/暂停按钮）。
      * 点击重置，倒计时恢复到最初设置的时长，并处于“暂停”状态。

##### 6.2.4 倒计时提醒

  * **结束提醒**: 当倒计时归零时，通过以下方式提醒用户：
      * **系统通知**: 发送一个 macOS 系统通知（`UNUserNotificationCenter`），包含倒计时标题。
      * **声音提示**: 播放一个简短的提示音。
      * **视觉提示**: 菜单栏图标可以有短暂的闪烁或颜色变化。
      * 倒计时项本身的状态变为“已完成”。

#### 6.3 数据模型 (Data Model)

```swift
struct CountdownItem: Identifiable, Codable, Equatable {
    let id: UUID
    var title: String
    var initialDuration: TimeInterval // 初始总时长（秒为单位）
    var remainingDuration: TimeInterval // 剩余时长（实时更新）
    var isRunning: Bool // 是否正在运行
    let createdAt: Date // 倒计时创建时间，用于排序
    var endTime: Date? // 倒计时预计结束时间，用于精确计算剩余时间，当isRunning为true时设置
}
```

  * `TimeInterval` 是 `Double` 的类型别名，用于表示秒数。
  * `endTime` 用于在应用不活跃时（例如 `NSPopover` 关闭）重新计算剩余时间，防止计时不准。当 `isRunning` 为 `true` 时，`endTime = Date().addingTimeInterval(remainingDuration)`。当应用重新激活或 `NSPopover` 再次显示时，`remainingDuration = endTime.timeIntervalSince(Date())`。

#### 6.4 数据持久化 (Data Persistence)

  * **方案**: 同样推荐使用 `FileManager` 将 `[CountdownItem]` 数组编码为 JSON 字符串保存到应用程序沙盒目录下的文件中。
  * **保存时机**:
      * 每次创建、删除、暂停、重置倒计时时立即保存。
      * 应用程序退出前保存。
  * **加载时机**: 应用程序启动时加载。

#### 6.5 技术实现细节 (SwiftUI & AppKit Integration)

  * **主应用结构**: 沿用之前提供的 `MyMenubarApp` 和 `AppDelegate` 结构。
  * **`NSPopover` 内容**: `ContentView` 将包含 `TabView` 来切换 Todo 和 Countdown 界面。
  * **状态管理**:
      * 创建 `CountdownListViewModel` 类，作为 `ObservableObject`，负责倒计时的创建、删除、播放/暂停、重置以及数据持久化。
      * 在 `CountdownListViewModel` 中使用 `Timer` 或 `DispatchSourceTimer` 来实现精确的倒计时逻辑。
  * **用户通知**: 使用 `UNUserNotificationCenter` 发送系统通知。
  * **声音播放**: 使用 `NSSound` 或 `AVFoundation` 播放提示音。

#### 6.6 错误处理与用户反馈

  * **输入校验**: 倒计时标题不能为空，时长必须大于零。
  * **权限请求**: 首次发送通知时，系统会自动请求用户权限。

-----

### 7\. 界面草图 (概念性)

```
+-------------------------------------+
| [菜单栏图标]                        |
+-------------------------------------+
|                                     |
|  +---------------------------------+  |
|  |           NSPopover             |  |
|  | +-----------------------------+ |  |
|  | | [待办事项] | [倒计时]         | |  |  <-- Top-level Tab/Segmented Control
|  | +-----------------------------+ |  |
|  |                                 | |  |
|  |             (当前为 "倒计时" Tab 内容)  | |
|  | +-----------------------------+ |  |
|  | |                               | |  |
|  | | +---------------------------+ | |  |
|  | | | 标题: 工作专注              | | |  |  <-- Countdown Item
|  | | | 剩余: 00:25:30 [暂停] [重置] | | |  |
|  | | +---------------------------+ | |  |
|  | |                               | |  |
|  | | +---------------------------+ | |  |
|  | | | 标题: 休息一下              | | |  |
|  | | | 剩余: 00:05:00 [播放] [重置] | | |  |
|  | | +---------------------------+ | |  |
|  | |                               | |  |
|  | | ...                           | |  |
|  | +-----------------------------+ | |  |
|  | |                               | |  |
|  | | [新建倒计时按钮/区域]         | |  |  <-- Create New Countdown
|  | +-----------------------------+ | |  |
|  +---------------------------------+  |
|                                     |
+-------------------------------------+
```

-----

### 8\. 技术栈

  * **主语言**: Swift
  * **UI 框架**: SwiftUI
  * **平台**: macOS
  * **持久化**: `FileManager` (JSON 编码/解码 `Codable` 数据)
  * **通知**: `UserNotifications` 框架
  * **计时**: `Timer` 或 `DispatchSourceTimer`

-----

### 9\. 开发计划 (新增/修改部分)

1.  **数据模型定义**: 定义 `CountdownItem` 结构体。
2.  **持久化服务**: 扩展 `TodoStore` (或创建独立的 `CountdownStore`) 负责加载和保存 `[CountdownItem]` 数组。
3.  **ViewModel**: 创建 `CountdownListViewModel`，管理倒计时的逻辑，并暴露给 SwiftUI 视图。
4.  **UI 实现**:
      * **主 `ContentView`**: 集成 `TabView` (或 Segmented Control) 来切换 Todo 和 Countdown 视图。
      * **Countdown 列表视图**: 实现倒计时列表的展示、播放/暂停、重置按钮。
      * **创建倒计时视图**: 实现标题输入和时长选择的 UI。
5.  **通知和声音**: 实现倒计时结束时的系统通知和声音播放。
